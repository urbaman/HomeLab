# Network for Proxmox

## Interface check

To check which interface is actually linked to which physical port, enable all of the interfaces. For each one:

```bash
ip link set dev eth1 up
```

Then, check where the following script gives a "1" result with the cable connected, moving the cable through the physical ports and taking note of the port-interface link.

```bash
for i in $( ls /sys/class/net ); do echo -n $i: ; cat /sys/class/net/$i/carrier; done
```

## Set the network (bonds, bridges, vlans)

```bash
# network interface settings; autogenerated
# Please do NOT modify this file directly, unless you know what
# you're doing.
#
# If you want to manage parts of the network configuration manually,
# please utilize the 'source' or 'source-directory' directives to do
# so.
# PVE will preserve these directives, but will NOT read its network
# configuration from sourced files, so do not attempt to move any of
# the PVE managed interfaces into external files!

auto lo
iface lo inet loopback

iface eno1 inet manual
#wan

auto vmbr0
iface vmbr0 inet static
	address 192.168.1.111/24
	gateway 192.168.1.1
	bridge-ports eno1
	bridge-stp off
	bridge-fd 0
#wan

iface eno2 inet manual
        mtu 9000
#bond0 - vlan30 - CephStorage

iface eno3 inet manual
        mtu 9000
#bond0 - vlan30 - CephStorage

iface eno4 inet manual
        mtu 9000
#bond0 - vlan30 - CephStorage

iface enp5s0f3 inet manual
        mtu 9000
#bond1 - vlan70 - TruenasStorage

iface enp5s0f2 inet manual
        mtu 9000
#bond1 - vlan70 - TruenasStorage

iface enp5s0f1 inet manual
        mtu 9000
#bond1 - vlan70 - TruenasStorage

iface enp5s0f0 inet manual
        mtu 9000
#bond2 - vlan90 - k8sStorage

iface enp141s0f0 inet manual
        mtu 9000
#bond2 - vlan90 - k8sStorage

iface enp141s0f1 inet manual
        mtu 9000
#bond2 - vlan90 - k8sStorage

iface enp141s0f2 inet manual
        mtu 9000
#bond3 - trunk

iface enp141s0f3 inet manual
        mtu 9000
#bond3 - trunk

iface enp129s0f0 inet manual
        mtu 9000
#bond3 - trunk

iface enp129s0f1 inet manual
        mtu 9000
#bond3 - trunk

auto bond0
iface bond0 inet manual
        bond-slaves eno2 eno3 eno4
        bond-miimon 100
        bond-mode 802.3ad
        bond-xmit-hash-policy layer2+3
        mtu 9000
#vlan30 - CephStorage

auto bond1
iface bond1 inet manual
        bond-slaves enp5s0f3 enp5s0f2 enp5s0f1
        bond-miimon 100
        bond-mode 802.3ad
        bond-xmit-hash-policy layer2+3
        mtu 9000
#vlan70 - TruenasStorage

auto bond2
iface bond2 inet manual
        bond-slaves enp5s0f0 enp141s0f0 enp141s0f1
        bond-miimon 100
        bond-mode 802.3ad
        bond-xmit-hash-policy layer2+3
        mtu 9000
#vlan90 - K8sStorage

auto bond3
iface bond3 inet manual
        bond-slaves enp141s0f2 enp141s0f3 enp129s0f1 enp129s0f0
        bond-miimon 100
        bond-mode 802.3ad
        bond-xmit-hash-policy layer2+3
        mtu 9000
#trunk

auto vmbr1
iface vmbr1 inet manual
        address 10.0.30.11/24
        bridge-ports bond0
        bridge-stp off
        bridge-fd 0
        mtu 9000
#vlan30 - CephStorage

auto vmbr2
iface vmbr2 inet manual
        bridge-ports bond1
        bridge-stp off
        bridge-fd 0
        mtu 9000
#vlan30 - TruenssStorage

auto vmbr3
iface vmbr3 inet manual
        bridge-ports bond2
        bridge-stp off
        bridge-fd 0
        mtu 9000
#vlan30 - K8sStorage

auto vmbr4
iface vmbr4 inet manual
        bridge-ports bond3
        bridge-stp off
        bridge-fd 0
        bridge-vlan-aware yes
        bridge-vids 1 10 20 30 40 50 60 70 80 90 100
        bridge-pvid 1
        mtu 9000
#trunk

auto vmbr4.20
iface vmbr4.20 inet static
        address 10.0.20.11/24
        mtu 9000
#vlan20 - ProxmoxCluster

auto vmbr4.80
iface vmbr4.80 inet static
        address 10.0.80.11/24
        mtu 9000
#vlan80 - ProxmoxMigration

auto vmbr4.100
iface vmbr4.100 inet static
        address 10.0.100.11/24
        mtu 9000
#vlan100 - Management
```
